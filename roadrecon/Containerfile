FROM python:3.13-slim AS backend

WORKDIR /app
RUN apt-get update && apt-get install -y git
RUN git clone https://github.com/dirkjanm/roadtools.git .
RUN pip install --no-cache-dir -e roadlib/ && pip install --no-cache-dir -e roadrecon/

FROM node:20 AS frontend

WORKDIR /app/roadrecon/frontend
COPY --from=backend /app/roadrecon/frontend .
RUN npm install -g @angular/cli@14.2.9
RUN npm install
RUN ng build --configuration production --output-path=/app/roadtools/roadrecon/dist_gui

FROM python:3.13-slim

WORKDIR /app/roadrecon_data
RUN apt-get update && apt-get install -y socat
COPY --from=backend /app /app
COPY --from=backend /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=backend /usr/local/bin /usr/local/bin
COPY --from=frontend /app/roadtools/roadrecon/dist_gui /app/roadrecon/roadtools/roadrecon/dist_gui

VOLUME /app/roadrecon_data

# Inline shell entrypoint to proxy GUI via socat & execs roadrecon
RUN echo '#!/bin/sh\n\
set -e\n\
socat TCP-LISTEN:5001,fork,reuseaddr TCP:127.0.0.1:5000 &\n\
SOCAT_PID=$!\n\
trap "kill $SOCAT_PID 2>/dev/null || true" EXIT INT TERM\n\
exec /usr/local/bin/roadrecon "$@"' > /usr/local/bin/entrypoint.sh && \
    chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 5001
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]